<include file="public@header" />
</head>
<body>
	<div class="wrap js-check-wrap">
		<ul class="nav nav-tabs">
			<li class="active"><a href="">{:lang('ADMIN_VENUE')}</a></li>
		</ul>
        <form class="well form-inline margin-top-20" method="post" action="{:url('venue/index')}">
            场馆名称:
            <input type="text" class="form-control" name="venue_name" style="width: 150px;" value="{:input('request.venue_name/s','')}" placeholder="请输入{:lang('VENUE_NAME')}">
            是否开放
            <select class="form-control" name="status" style="width: 120px;">
            	<option value="" selected="selected">请选择</option>
            	<option value="1" <if condition="input('request.status/s') eq '1'">selected</if>>开放</option>
            	<option value="0" <if condition="input('request.status/s') eq '0'">selected</if>>关闭</option>
            </select>
            <input type="submit" class="btn btn-primary" value="搜索" />
            <a class="btn btn-danger" href="{:url('venue/index')}">清空</a>
        </form>

        <button class="btn btn-info" onclick="add_venue();">添加场馆</button>

		<table class="table table-hover table-bordered margin-top-10">
			<thead>
				<tr>
					<th width="50">ID</th>
					<th>{:lang('VENUE_NAME')}</th>
					<th>{:lang('VENUE_IMG')}</th>
					<th>{:lang('AREA')}</th>
					<th>{:lang('OPEN_TIME')}</th>
					<th>{:lang('CLICK_NUM')}</th>
					<th width="150">{:lang('INTRODUCTION')}</th>
					<th>{:lang('CREATE_TIME')}</th>
					<th>{:lang('UPDATE_TIME')}</th>					
					<th>{:lang('STATUS')}</th>
					<th width="130">{:lang('ACTIONS')}</th>
				</tr>
			</thead>
			<tbody>
				<noempty name="list">
					<php>
						$statuses = array('0'=>lang('CLOSE'), '1'=>lang('OPEN'));
					</php>
					<foreach name="list" item="vo">
						<tr>
							<td>{$vo.id}</td>
							<td>{$vo.venue_name}</td>
							<td><img width="50" height="50" src="{:url('admin/venue/get_venue_img', array('id'=>$vo.id))}"></td>
							<td>{$vo.id}</td>
							<td>{$vo.open_time}</td>
							<td>{$vo.click_num}</td>
							<td width="150"><div class="text-ellipsis">{$vo.venue_desc}</div></td>
							<td>{$vo.create_time|date="Y-m-d", ###}</td>
							<td>{$vo.update_time|date="Y-m-d", ###}</td>
							<td>{$statuses[$vo.status]}</td>
							<td>
								<a href="{:url('venue/place', array('venue_id'=>$vo.id))}">{:lang('ADMIN_PLACE')}</a>
								<a href="javascript:;" onclick="edit_venue('{$vo.id}');">{:lang('EDIT')}</a>
								<if condition="$vo.status eq 1">
									<a class="js-ajax-delete" data-msg="确定关闭它吗？" href="{:url('venue/change_status',array('id'=>$vo['id'],'status'=>0,'table'=>'venue'))}">{:lang('CLOSE')}</a>
								<else/>
									<a class="js-ajax-delete" data-msg="确定开放它吗？" href="{:url('venue/change_status',array('id'=>$vo['id'],'status'=>1,'table'=>'venue'))}">{:lang('OPEN')}</a>
								</if>
							</td>
						</tr>
					</foreach>
				</noempty>
			</tbody>
		</table>
		<empty name="list">
			<div class="no_data">暂时没有场馆信息</div>
		</empty>
		<div class="pagination">{$page}</div>

		<!-- 场馆模态框 -->
		<div class="modal" id="add_modal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true" data-backdrop="false">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" modalaria-hidden="true">&times;</button>
						<h4 class="modal-title" id="addModalLabel">添加、编辑场馆</h4>
					</div>

					<div class="modal-body">
						<form role="form" id="venue_form" class="form-horizontal">
							<input type="hidden" name="id" id="id">
							<input type="hidden" name="action" id="action">

							<div class="form-group">
								<label for="venue_name" class="col-md-2 control-label">场馆名称</label>
								<div class="col-md-10">
									<input type="text" name="venue_name" id="venue_name" class="form-control">
								</div>
							</div>

							<div class="form-group">
								<label for="venue_img" class="col-md-2 control-label">场馆图片</label>
								<div class="col-md-10">
									<input type="hidden" name="photo_url" id="venue-img">
									<input type="text" name="photo_name" id="venue-img-name" placeholder="请上传图片" class="form-control">
									<a href="javascript:uploadOneImage('图片上传', '#venue-img');">上传</a>
								</div>
							</div>

							<div class="form-group">
								<label for="venue_area" class="col-md-2 control-label">选择地区</label>
								<div id="venue_area" class="col-md-10 form-inline">
									<select id="province" name="province" class="form-control" style="width: 150px;" onchange="get_city(this.value)">
									</select>
									<select id="city" name="city" class="form-control" style="width: 150px;" onchange="get_area(this.value)">
									</select>
									<select id="area" name="area" class="form-control" style="width: 150px;">
									</select>
								</div>
							</div>

							<div class="form-group">
								<label for="status" class="col-md-2 control-label">是否开放</label>
								<div id="status" class="col-md-10">
									<label class="radio-inline">
										<input type="radio" name="status" id="status_1" value="1" checked="checked">开放
									</label>
									<label class="radio-inline">
										<input type="radio" name="status" id="status_0" value="0">关闭
									</label>
								</div>
							</div>

							<div class="form-group">
								<label for="open_time" class="col-md-2 control-label">开放时间</label>
								<div class="col-md-10">
									<textarea name="open_time" id="open_time" class="form-control" rows="2"></textarea>
								</div>
							</div>

							<div class="form-group">
								<label for="desc" class="col-md-2 control-label">场馆简介</label>
								<div class="col-md-10">
									<textarea name="desc" id="desc" class="form-control" rows="3"></textarea>
								</div>
							</div>
						</form>
					</div>

					<div class="modal-footer">
						<button type="button" class="btn btn-primary" onclick="submit_venue();">提交</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="__STATIC__/js/admin.js"></script>
	<script type="text/javascript">
		var area_id = 0;
		var city_id = 0;
		var province_id = 0;

		function add_venue()
		{
			area_id = 0;
			city_id = 0;
			province_id = 0;

			get_province();
			$('#id').val('');
			$('#action').val('add');
			$('#venue_name').val('');
			$('#venue-img-name').val('');
			$('#status_1').prop('checked', true);
			$('#open_time').val('');
			$('#desc').val('');

			$('#add_modal').modal();
		}

		function edit_venue(id)
		{
			$.ajax({
				type: "POST",
				url: "{:url('venue/get_info')}",
				data: {'id' : id, 'table' : 'venue'},
				dataType: "json",
				success: function(data){
					if(data.status == 1){
						var info = data.data;
						area_id = info.area_id;
						city_id = info.city_id;
						province_id = info.province_id;
						get_province();

						$('#id').val(id);
						$('#action').val('edit');
						$('#venue_name').val(info.venue_name);
						$('#venue-img-name').val(info.venue_img);
						$('#status_' + info.status).prop('checked', true);
						$('#open_time').val(info.open_time);
						$('#desc').val(info.venue_desc);

						$('#add_modal').modal();
					}else{
						layer.msg(data.msg, {time:3000, icon:2});
					}
				},
				error: function(e){
					layer.msg('服务器繁忙，请联系客服！', {time:3000, icon:2});
				}
			});
		}

		function get_province(id = '')
		{
			$.ajax({
				type: "POST",
				url: "{:url('venue/get_region')}",
				data: {'id' : id, 'level' : 1},
				dataType: 'json',
				success: function(data){
					if(data.status == 1){
						var province_option;
						var province_data = data.data;

						$('#province option').remove();

						for(var i=0; i<province_data.length; i++){
							if(province_id == province_data[i]['id']){
								province_option = "<option value=\"" + province_data[i]['id'] + 
													"\" selected>" + province_data[i]['name'] + 
													"</option>";
							}else{
								province_option = "<option value=\"" + province_data[i]['id'] + 
													"\">" + province_data[i]['name'] + 
													"</option>";
							}

							$('#province').append(province_option);
						}
						get_city($('#province').val());
					}else{
						layer.msg(data.msg, {time:3000, icon:2});
					}
				},
				error: function(e){
					layer.msg('地区获取失败，请联系客服！', {time:3000, icon:2});
				}
			});
		}		

		function get_city(id = '')
		{
			$.ajax({
				type: "POST",
				url: "{:url('venue/get_region')}",
				data: {'id' : id, 'level' : 2},
				dataType: 'json',
				success: function(data){
					if(data.status == 1){
						var city_option;
						var city_data = data.data;

						$('#city option').remove();

						for(var i=0; i<city_data.length; i++){
							if(city_id == city_data[i]['id']){
								city_option = "<option value=\"" + city_data[i]['id'] + 
											"\" selected>" + city_data[i]['name'] + 
											"</option>";
							}else{
								city_option = "<option value=\"" + city_data[i]['id'] + 
											"\">" + city_data[i]['name'] + 
											"</option>";
							}
							
							$('#city').append(city_option);
						}
						get_area($('#city').val());
					}else{
						layer.msg(data.msg, {time:3000, icon:2});
					}
				},
				error: function(e){
					layer.msg('地区获取失败，请联系客服！', {time:3000, icon:2});
				}
			});
		}

		function get_area(id = '')
		{
			$.ajax({
				type: "POST",
				url: "{:url('venue/get_region')}",
				data: {'id' : id, 'level' : 3},
				dataType: 'json',
				success: function(data){
					if(data.status == 1){
						var area_option;
						var area_data = data.data;

						$('#area option').remove();

						for(var i=0; i<area_data.length; i++){
							if(area_id == area_data[i]['id']){
								area_option = "<option value=\"" + area_data[i]['id'] + 
											"\" selected>" + area_data[i]['name'] + 
											"</option>";
							}else{
								area_option = "<option value=\"" + area_data[i]['id'] + 
											"\">" + area_data[i]['name'] + 
											"</option>";
							}
							
							$('#area').append(area_option);
						}

					}else{
						layer.msg(data.msg, {time:3000, icon:2});
					}
				},
				error: function(e){
					layer.msg('地区获取失败，请联系客服！', {time:3000, icon:2});
				}
			});	
		}

		function submit_venue()
		{
			$.ajax({
				type: "POST",
				url: "{:url('venue/handle_venue')}",
				data: $('#venue_form').serialize(),
				dataType: 'json',
				success: function(data){
					if(data.status == 1){
						layer.msg(data.msg, {time:3000, icon:1}, function(){
							window.location.reload();
						});
					}else{
						layer.msg(data.msg, {time:3000, icon:2});
					}
				},
				error: function(e){
					layer.msg('服务器繁忙，请联系客服！', {time:3000, icon:2});
				}
			});
		}
	</script>
</body>
</html>